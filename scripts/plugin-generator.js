const inquirer = require('inquirer');
const chalk = require('chalk');
const fs = require('fs');
const path = require('path');

async function run() {
    console.log(chalk.cyan.bold('\nüõ†Ô∏è Echo Plugin Generator\n'));
    console.log(chalk.gray('Enter the details for your new plugin:\n'));

    const answers = await inquirer.prompt([
        {
            type: 'input',
            name: 'name',
            message: 'Plugin Name (kebab-case, e.g., my-cool-plugin):',
            validate: (input) => {
                if (!/^[a-z0-9-]+$/.test(input)) {
                    return 'Please enter a valid kebab-case name (lowercase, numbers, and hyphens only).';
                }
                return true;
            }
        },
        {
            type: 'input',
            name: 'version',
            message: 'Version:',
            default: '1.0.0'
        },
        {
            type: 'input',
            name: 'description',
            message: 'Description:',
            default: 'A brief description of my custom plugin'
        },
        {
            type: 'input',
            name: 'author',
            message: 'Author Name:',
            default: () => process.env.USERNAME || process.env.USER || 'Echo Developer'
        },
        {
            type: 'input',
            name: 'commandName',
            message: 'Name of the first command:',
            default: 'hello',
            validate: (input) => {
                if (!/^[a-z0-9]+$/.test(input)) {
                    return 'Command name should be lowercase alphanumeric.';
                }
                return true;
            }
        },
        {
            type: 'input',
            name: 'commandDesc',
            message: 'Description for this command:',
            default: 'Say hello to someone'
        }
    ]);

    const pluginTemplate = `/**
 * ${answers.name} Plugin for Echo
 * 
 * Generated by Echo Plugin Generator
 */

module.exports = {
    // Plugin metadata
    name: '${answers.name}',
    version: '${answers.version}',
    description: '${answers.description}',
    author: '${answers.author}',

    // Optional: Initialize plugin (runs once when loaded)
    init: async function() {
        console.log('${answers.name} plugin initialized!');
    },

    // Command definitions
    commands: {
        /**
         * Command: ${answers.commandName}
         * Description: ${answers.commandDesc}
         */
        ${answers.commandName}: async function(args) {
            const subject = args || 'world';
            return {
                success: true,
                message: \`Hello, \${subject}! This command was executed from ${answers.name} plugin.\`
            };
        }
    },

    // Optional: Command descriptions for help/AI
    commandDescriptions: {
        ${answers.commandName}: '${answers.commandDesc}'
    },

    // Optional: Cleanup when plugin is disabled
    cleanup: async function() {
        console.log('${answers.name} plugin cleaned up!');
    }
};
`;

    const pluginsDir = path.join(__dirname, '..', 'plugins');
    const fileName = `${answers.name}.js`;
    const filePath = path.join(pluginsDir, fileName);

    if (fs.existsSync(filePath)) {
        const { overwrite } = await inquirer.prompt([
            {
                type: 'confirm',
                name: 'overwrite',
                message: chalk.yellow(`‚ö†Ô∏è  File ${fileName} already exists. Overwrite?`),
                default: false
            }
        ]);
        if (!overwrite) {
            console.log(chalk.red('\n‚úñ Aborted.'));
            return;
        }
    }

    fs.writeFileSync(filePath, pluginTemplate);

    console.log(chalk.green(`\n‚úì Plugin '${answers.name}' created successfully at:`));
    console.log(chalk.cyan(`  ${filePath}\n`));
    
    const { enable } = await inquirer.prompt([
        {
            type: 'confirm',
            name: 'enable',
            message: 'Would you like to enable this plugin now?',
            default: true
        }
    ]);

    if (enable) {
        const ConfigManager = require('./config-manager');
        const config = new ConfigManager();
        const enabledPlugins = config.get('plugins') || [];
        if (!enabledPlugins.includes(answers.name)) {
            enabledPlugins.push(answers.name);
            config.set('plugins', enabledPlugins);
            console.log(chalk.green(`‚úì Plugin '${answers.name}' is now enabled.`));
        }
    }

    console.log(chalk.gray('\nYou can now use your plugin in Echo!'));
}

module.exports = { run };
